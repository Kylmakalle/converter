<!DOCTYPE html>
<html>

<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>FFMPEG WASM Video Crop</title>
</head>

<body>
    <input type="file" id="fileInput" accept="video/*" />
    <br />
    <div id="timeTaken"></div>
    <br />
    <video id="videoOutput" controls></video>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.1/dist/ffmpeg.min.js"></script>
    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        // const ffmpeg = createFFmpeg({
        //     corePath: "https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js",
        //     log: true,
        // });

        const ffmpeg = createFFmpeg({
            corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js',
            log: true,
            mainName: 'main',
        });

        const fileInput = document.getElementById('fileInput');
        const videoOutput = document.getElementById('videoOutput');
        const timeTakenElement = document.getElementById('timeTaken');

        const ffmpegLoadPromise = ffmpeg.load();

        // function generateUUID() {
        //     return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        //         var r = Math.random() * 16 | 0,
        //             v = c == 'x' ? r : (r & 0x3 | 0x8);
        //         return v.toString(16);
        //     });
        // }

        // async function uploadVideoChunks(byteArray) {
        //     const chunkSize = 5 * 1024 * 1024; // 5MB
        //     let offset = 0;
        //     let chunkNumber = 0;
        //     const totalChunks = Math.ceil(byteArray.length / chunkSize);
        //     const formData = new FormData();

        //     while (offset < byteArray.length) {
        //         const chunk = byteArray.slice(offset, offset + chunkSize);
        //         formData.append('file', new Blob([chunk]), `chunk_${chunkNumber}.mp4`);
        //         offset += chunkSize;
        //         chunkNumber++;
        //     }

        //     try {
        //         const response = await fetch('https://telegra.ph/api/upload', {
        //             method: 'POST',
        //             body: formData,
        //         });

        //         const responseData = await response.json();
        //         const uploadedUrls = responseData.map((file) => file.url);
        //         return uploadedUrls;
        //     } catch (error) {
        //         console.error('Error uploading video chunks:', error);
        //         return [];
        //     }
        // }

        async function processVideo(file) {
            ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));

            console.log("Running ffmpeg");
            const startTime = performance.now();
            await ffmpeg.run('-i', 'input.mp4', '-vf', 'crop=640:640:0:0', '-preset', 'superfast', 'output.mp4');
            const endTime = performance.now();
            const timeTakenMs = endTime - startTime;
            const timeTakenSec = timeTakenMs / 1000; // Convert milliseconds to seconds
            console.log('Time taken:', timeTakenSec, 's');
            timeTakenElement.textContent = 'Time taken: ' + timeTakenSec + ' s';

            const outputData = ffmpeg.FS('readFile', 'output.mp4');
            const outputBlob = new Blob([outputData.buffer], { type: 'video/mp4' });
            const outputUrl = URL.createObjectURL(outputBlob);
            videoOutput.src = outputUrl;


            // Create a FormData object to send the video file
            const formData = new FormData();
            formData.append('file', outputBlob, 'video.mp4');

            // Send the video file to the server using a fetch request
            const uploadUrl = 'https://localhost.akentev.com/8000/upload';  // Replace with your server's upload URL
            const headers = new Headers();
            headers.append("web_app_data", window.Telegram.WebApp.initData);
            fetch(uploadUrl, {
                method: 'POST',
                body: formData,
                headers: headers
            })
                .then(response => {
                    if (response.ok) {
                        const response_text = response.text();
                        console.log(`Video uploaded successfully. id: ${response_text}`);
                        window.Telegram.WebApp.sendData(JSON.stringify({ "cmd": "send_upload", "id": response_text }));
                    } else {
                        console.error(`Upload failed. ${response.status} ${JSON.stringify(response)}.`);
                    }
                })
                .catch(error => {
                    console.error('Upload Error:', error);
                });
            // const maxDataSize = 4096;
            // const maxMetadataSize = 96;
            // const maxChunkSize = Math.floor((maxDataSize - maxMetadataSize) * 65 / 100);
            // const totalChunks = Math.ceil(outputData.byteLength / maxChunkSize);
            // const uuid = generateUUID();

            // for (let i = 0; i < totalChunks; i++) {
            //     let start = i * maxChunkSize;
            //     let end = start + maxChunkSize <= outputData.length ? start + maxChunkSize : undefined;
            //     let chunkData = outputData.slice(start, end);
            //     let encodedChunkData = btoa(String.fromCharCode.apply(null, chunkData));

            //     let dataString = `1:${uuid}:${totalChunks}:${i}:${encodedChunkData}`;
            //     console.log("Sending data:");
            //     console.log(dataString);
            //     window.Telegram.WebApp.sendData(dataString);
            // }

        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];

            if (!ffmpeg.isLoaded()) {
                await ffmpegLoadPromise; // Await initialization if not already in progress
            }
            await processVideo(file);
        });

    </script>
    <script>
        window.Telegram.WebApp.onEvent('mainButtonClicked', async () => {
            const fileInput = document.getElementById('fileInput');
            fileInput.click();
        })
        window.Telegram.WebApp.MainButton.setParams({ "text": "Select video" });
        window.Telegram.WebApp.MainButton.show();
    </script>
</body>

</html>
